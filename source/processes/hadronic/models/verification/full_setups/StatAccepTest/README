
 Last update: 24-Feb-2009
 ========================

 This directory contains a configurable calorimeter setup to be used
 as statistical acceptance suite of Geant4, that is to validate a
 new release with respect the previous one (regression test).

 The setup Bash script, exerciseSetup.sh, is meant for the Grid,
 under the assumption that all the needed software is installed
 in the directory  $VO_GEANT4_SW_DIR/dirInstallations 
 (the environmental variable VO_GEANT4_SW_DIR is automatically
  defined when you run on the Grid).

 To add flexibility to this tool, it is possible to send to a
 Grid site, together with the job, also a Geant4 release and this 
 application directory (StatAccepTest/). If such Geant4 release is 
 found in the parent directory of the application directory 
 (i.e. in ../StatAccepTest/), then this release is used; if not, 
 then it will be taken from $VO_GEANT4_SW_DIR/dirInstallations .

 If you want to run on your computer, then you need to modify
 the setup script: look at  exerciseSetup.sh  and  build.py .

 In the main program  * mainStatAccepTest.cc *  you can select 
 the Physics List (LHEP, QGSP, QGSP_BERT, QGSP_BIC), in the macro
 command file  * exercise.g4 *  you can choose which particle to shoot,
 the beam energy, the number of events, and the kind of calorimeter
 you are interested in, and also, eventually, a transverse magnetic 
 field (see that command file to look at the various options available).

 The calorimeter is a cylinder, with the axis (length of the 
 cylinder) along the beam direction, which is along the Z-axis.
 This radius of the calorimeter, and the total thickness
 of the absorber, can be specified either in unit of lambdas 
 of the absorber material, or in normal length in [mm]. 
 The user has to specified also the thickness (in [mm]) of a
 single layer of active material, and the number of layers.
 Also the number of readout layers can be specified, in the
 case it is different than the number of active layers: if the
 number of readout layers is not explicitly set, then it is 
 assumed to be the same as the number of active layers; if it 
 is set explicitly, then it must be a divisor of the number of
 active layers, otherwise it is forced to be equal to it.
 (Notice that the concept of "readout layer" appears only at
  the level of analysis, not at the level of detector 
  construction.)
 In the case of an homogeneous calorimeter, for instance PbWO4,
 the number of layers indicate essentially the number of sampling
 we can have for the longitudinal shower profile.
 Finally, the number of bins for the lateral shower profile should
 also be specified, and the width (radius) of the first bin in unit
 of lambda (of the absorber) or in [mm]. The bins have incresing
 size as the radius grows, in such a way to keep enough statistics
 in spite of the rapid decrease of the shower with the radius.   
 Notice that, due to HBOOK limitations, there should be not
 more than 100 layers for the longitudinal shower profile, 
 and not more than 30 layers for the lateral shower profile.
 
 In the case of Scintillator as active material, it is possible
 to switch on the quenching effect as described by the Birks' law.
 By the default it is not active; to switch it on, and to have 
 more details, look at the string "***LOOKHERE***" in the file: 
 StatAccepTestSensitiveCalorimeter.cc .

 In the case you want to run the simulation only to get the 
 information printed out (in the screen) at the end of execution,
 without the ntuple and the histograms, then it is enough to
 not define the environmental variable  G4ANALYSIS_USE . 
 In this case, you do not need AIDA.

 If the environmental variable G4ANALYSIS_USE is defined (and
 you have an AIDA implementation), then the output of the program
 is an HBOOK ntuple  * ntuple.hbook *  which contains some 
 physics variables, like the total energy deposit in the active layers,
 the total deposit in the whole calorimeter, the energy deposit in 
 each active layer, and the transverse energy deposition sum over all
 the active layers, in a certain number of radial bins.

 In the same HBOOK file, also a number of histograms can be
 produced, describing the following information:
    -  step energy vs. step length (2D histograms)
    -  kinetic energy spectra of some particles, entering
       some active layers.
 (Please look for ***LOOKHERE*** in src/StatAccepTestAnalysis.cc
  to switch on/off these histograms, which can also be steered
  from the main program. By default, the 2D histograms (step
  energy vs. length) are switched off, whereas the others are
  active.)

 The ntuple is then used in the stand-alone (i.e. independent from
 Geant4) program  pvalue , in the subdirectory dirStat/.
 This program reads two ntuples, ntuple_a.hbook and ntuple_b.hbook,
 which can be obtained by running the same simulation program,
 mainStatAccepTest, and with same configuration, run.g4,
 for the two versions of Geant4 that we want to compare.
 The program pvalue make the statitical tests between the
 various distributions, and signal a  ***WARNING***  when the
 p-value of that test is below a certain threshold, fixed at 1%.
 Notice that this does not mean necessarily that the two 
 distributions are statistically incompatible with each other,
 because, by definition, 1% of pair of distributions coming
 from the same parent distributions have a p-value below 1%.
 However, it is worth to take a look by eye to those distributions
 to see if there are really so different as could be in the
 presence of a bug.
 Colours in the plot: the first Geant4 version, i.e. "REF1" in
 in the main script mainScript.py, is plotted in RED; the second
 Geant4 version, i.e. "REF2" in mainScript.py, is plotted in BLUE. 

 The program is also printing, at the end, some useful information
 (with statistical errors):
   o  max total energy deposited in the whole calorimeter; 
   o  average energy deposited in all active layers;
   o  average energy deposited in the whole calorimeter;
   o  average energy deposited in each layer (longitudinal profile);
   o  fractions of visible energy deposited in the four quarters;
   o  average energy deposited in each ring (transverse profile);
   o  fractions of visible energy deposited in the three thirds of
      the rings;
   o  energy resolution;
   o  sampling fraction;
   o  average number of steps and tracks per event;
   o  average track length for some particles;
   o  average step length and number of steps for some particles;
   o  information about the kinetic energy of exiting particles.

 Some scripts and one kumac has been provided to allow a full
 automatization of this Statistical Acceptance suite.
 Here is the structure of these scripts/kumac:

    1)  mainScript.py 
         ---> 2)  simuDriver.sh  
                  ---> 3a)  build.py
                  ---> 3b)  execute mainAcceptanceTest
                  ---> 3c)  dirStat/driver.py        
                            ---> 4)  drivePlot.py
                                     ---> 5a)  execute  pvalue 
                                     ---> 5b)  plot.py
                                               ---> 6) plot.kumac

 only the first one, mainScript.py , needs to be modified by the user.

 After the whole simulation is completed, a post-processing phase
 must be performed in order to produce plots of various observables.
 This phase requires that all the output files of the simulation
 are collected in the same directory tree (eventual with a 
 subdirectory structure), whereas the HBOOK files (ntuples) are
 not needed. 
 The subdirectory  dirObservables/  contains a Python script,
 observables.py , and some kumacs that are invoked by the script
 to produce the plots. The user is required simply to set some
 parameters in the  observables.py  script, and then run it.
 Please read the comments at the top of the file  observables.py
 for more information.

 Other scripts have been added in the same subdirectory  
 ( dirObservables/ ) :
   o  unpack.py
   o  createListPlots.py
   o  pvalues.py
   o  compare2.py
   o  compareAll.py
   o  addInfoInTable.py
   o  printInfoLogfile.py
   o  reproducibility.py
   o  reproducibilityAll.py
 The first three are useful immediately after you get the results 
 from the Grid jobs.
 compare2.py is useful to have detailed information  on the 
 difference between two cases.
 compareAll.py is useful to have the detailed information of 
 all cases, and the averages (overall, by calorimeter
 type, by beam particle, and by beam energy).
 addInfoInTable.py, which uses printInfoLogFile.py, is useful
 to summarize the main results in a table. 
 reproducibility.py is useful to test the reproducibility for
 a single case (beam particle, beam energy, calorimeter type).
 reproducibilityAll.py is useful to test the reproducibility
 for several combinations of (beam particle, beam energy,
 calorimeter type): only the Physics List is fixed.
 Please read the comments at the top of these files for more
 information.

 The files that end with  "-m32"  have been added to allow
 to build/run in 32-bit compatibility mode in 64-bit architectures.
 For 32-bit architectures, whether you use these files, or the
 corresponding "normal" ones (i.e. without the  "-m32"  extension),
 nothing will change: you always build/run in 32-bit mode.
 For 64-bit architectures, if you use the corresponding "normal"
 files (i.e. without the  "-m32"  extension), then you build/run
 in native 64-bit mode.


 Other subdirectories :
 
 The subdirectory  dirPower/  is dedicated to the study of the
 statistical power of the Acceptance Suite. You can find more
 information in the README file in that subdirectory.

 The subdirectory  dirUseCases/  contains a set of Geant4 macro
 files to configure the calorimeter as closely as possible to
 the LHC electromagnetic and hadronic calorimeters.

 The subdirectory  dirCPUbench/  is dedicated to some CPU performance
 benchmarks of Geant4 (see the README file in that directory).

 The subdirectory  dirEnergyScan/  is dedicated to the study of
 calorimeter observables (in particular, visible energy and
 energy resolution) as a function of the beam energy, scanning
 the interval 1 - 30 GeV and few extra higher energies
 (usually 50 GeV, 100 GeV, 200 GeV).
 (See the README file in that directory.)

 The subdirectory  dirFluka/  is dedicated to the study of
 the same set of simplified calorimeters used for Geant4
 in the case of Fluka simulation program.

