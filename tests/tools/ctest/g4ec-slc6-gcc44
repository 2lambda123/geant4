#!/usr/bin/env bash

ulimit -a 

#------------------------------------------------------------------
export LC_CTYPE=en_US.UTF-8
export LC_ALL=en_US.UTF-8

CONFIG=slc6-gcc44

#---Enable FPE -----------------------------------------------------
export CXXFLAGS=-DG4FPE_DEBUG

externals=/afs/cern.ch/sw/lcg/experimental
platform=x86_64-${CONFIG}-opt

#---CMake----------------------------------------------------------
export PATH=/afs/cern.ch/sw/lcg/external/CMake/2.8.9/Linux-i386/bin:${PATH}

#---Xerces-C-------------------------------------------------------
version=3.1.1p1
#export XERCESC_ROOT_DIR=${externals}/XercesC/${version}/${platform}
#export LD_LIBRARY_PATH=${XERCESC_ROOT_DIR}/lib:${LD_LIBRARY_PATH}

#---Inventor--------------------------------------------------------
version=3.1.3p2
export PATH=${externals}/coin3d/${version}/${platform}/bin:${PATH}
export LD_LIBRARY_PATH=${externals}/coin3d/${version}/${patform}/lib:${LD_LIBRARY_PATH}

#---CLHEP----------------------------------------------------------
version=2.1.3.1
export CLHEP_ROOT_DIR=${externals}/clhep/${version}/${platform}
export LD_LIBRARY_PATH=${CLHEP_ROOT_DIR}/lib:${LD_LIBRARY_PATH}

#---Qt-------------------------------------------------------------
version=4.8.4
export QTDIR=${externals}/qt/${version}/${platform}

#---ROOT-----------------------------------------------------------
version=5.34.05
. ${externals}/ROOT/${version}/${platform}/bin/thisroot.sh

#---Python--------------------------------------------------------
#Needed for PhysicsChecks: python compatible with ROOT
version=2.7.3
export PATH=${externals}/Python/${version}/${platform}/bin:${PATH}
export LD_LIBRARY_PATH=${externals}/Python/${version}/${platform}/lib:${LD_LIBRARY_PATH}

#---GCCXML--------------------------------------------------------
version=0.9.0_20120309p2
export PATH=${externals}/gccxml/${version}/${platform}/bin:${PATH}

#---Compiler------------------------------------------------------
# Default compiler
#-----------------------------------------------------------------

THIS=$(dirname $0)

if [ x$MODE = x ]; then
  export MODE=nightly
fi
if [ x$WORKDIR = x ]; then 
  WORKDIR=/ec/G4-builds
fi
if [ x$VERSION = x ]; then 
  export VERSION=g4tags-dev
fi

if [ x$BUILDTYPE = x ]; then
   PLATFORM=${WORKDIR}/${MODE}/${CONFIG}
else
   PLATFORM=${WORKDIR}/${MODE}/${CONFIG}-${BUILDTYPE}
fi

export SOURCE=${PLATFORM}/${VERSION}
export BINARY=${PLATFORM}/build


#
#default, to be modified for non default buildtypes
#
  export G4_XOPTS="-DGEANT4_USE_G3TOG4=ON;\
-DGEANT4_USE_OPENGL_X11=ON;\
-DGEANT4_USE_QT=${Use_QT};\
-DGEANT4_USE_RAYTRACER_X11=ON;\
${Use_CLHEP};\
-DGEANT4_USE_XM=ON"


case "${BUILDTYPE}" in 

   staticlibs)
	   export G4_XOPTS="-DBUILD_STATIC_LIBS=ON;-DBUILD_SHARED_LIBS=OFF"
	   ;;
   MT)
	   export G4_XOPTS="${G4_XOPTS};-DGEANT4_BUILD_MULTITHREADED=ON"
	   ;;
esac

if [ "${RESET_SOURCE}" = "yes" ]; then
  rm -rf ${SOURCE}
fi

if [ ! -d "${SOURCE}" ]; then
  ${THIS}/g4tagsvn.py update -c ${VERSION} -d ${SOURCE} -q
fi

#---Run the CTest script-------------------------------------------
echo "Starting CTest script for configutation ${CONFIG} at `date`" 
ctest -V -S ${THIS}/g4${MODE}.cmake 



