$Id: README,v 1.9 2002/12/12 19:16:18 gunter Exp &
-------------------------------------------------------------------

     =========================================================
     Geant4 - an Object-Oriented Toolkit for Simulation in HEP
     =========================================================

                        purgin_magnet
                        -------------
                     s. Larsson, October 2003

-----------------------------------------------------------------
Acknowledgments to GEANT4 people, in particular to J. Apostolakis,
J Generowicz, G. Folger, Vladimir Ivanchenko,  M.G.Pia and 
S. Guatelli. 
-----------------------------------------------------------------

0. Introduction
----------------

This example simulates electrons traveling through a 3D magnetic field. 

The Purging Magnet example is an application of Geant4 in a medical
environment. It simulates a strong purging magnet in a treatment head. 
The geometry is very simplified. The major idea of this example is to 
implement an external magnetic field grid and test if the deviation of 
electrons are as expected in this particular field. The data (position, 
energy and momentum) are collected in a measurement volume.The data is 
stored in a HBOOK file if the user has set up the AIDA 3.0 environment 
and Anaphe is available.
 
  
1. Setting up the environment variables
---------------------------------------

- Environment with the compiler 2.95.2

#---- Set compiler-after update pcgeant2 16.04.2003
source /afs/cern.ch/sw/geant4/dev/scripts/gcc2952.csh

#----Linux setup
setenv G4SYSTEM Linux-g++

setenv CLHEP_BASE_DIR /afs/cern.ch/sw/geant4/dev/CLHEP/$G4SYSTEM/1.8

#---- Chose where you want your Libraries and work directory
setenv G4INSTALL /...
setenv G4WORKDIR /...
setenv G4LIB     /...

#----Data Libraries
setenv G4DEVPATH /afs/cern.ch/sw/geant4/dev

setenv G4LEDATA /afs/cern.ch/sw/geant4/stt/dev1/src/G4EMLOW0.3
setenv NeutronHPCrossSections $G4DEVPATH/data/G4NDL
setenv G4LEDATA $G4DEVPATH/data/G4EMLOW
setenv G4LEVELGAMMADATA $G4INSTALL/data/PhotonEvaporation
setenv G4RADIOACTIVEDATA $G4INSTALL/data/RadiativeDecay


- Setup for Visualization 

IMPORTANT: be sure that your Geant4 installation has been done 
with the proper visualization drivers; for details please see the 
file geant4/source/visualization/README. 

To use the visualization drivers set the following variables in 
your local environment: 

# ---- set up VRMLview
setenv G4VIS_BUILD_VRMLFILE_DRIVER  1
setenv G4VIS_USE_VRML               1
setenv G4VIS_USE_VRMLFILE           1
setenv G4VRMLFILE_MAX_FILE_NUM     100
setenv G4VRMLFILE_VIEWER        vrmlview    #if installed
setenv G4VIS_USE_VRML               1
setenv G4VIS_USE_VRMLFILE           1
setenv PATH ${PATH}:"/afs/cern.ch/sw/contrib/VRML/bin/Linux"

# ---- set up OpenGL or Mesa
setenv G4VIS_BUILD_OPENGLX_DRIVER   1
setenv G4VIS_USE_OPENGLX            1
setenv OGLHOME /afs/cern.ch/sw/geant4/dev/Mesa/Linux-g++

# ---- set up DAWN
setenv G4VIS_BUILD_DAWN_DRIVER      1
setenv G4VIS_BUILD_DAWNFILE_DRIVER  1
setenv G4VIS_USE_DAWN               1
setenv G4VIS_USE_DAWNFILE           1
setenv PATH ${PATH}:"/afs/cern.ch/sw/geant4/dev/DAWN/Linux-g++"

setenv LD_LIBRARY_PATH $OGLHOME/lib


- Set up for analysis using AIDA

To compile this example (like GammaRayTel) with the analysis tools activated, 
set the following variables 

setenv G4ANALYSIS_USE               1 # Use the analysis tools

and be sure to have the right path to the Anaphe library (or to another AIDA
compliant implementation), inserting this on the .tcshrc or .bashrc:

(on a CERN machine with the gcc-2.95 compiler)	

# ---- Analysis
setenv G4ANALYSIS_USE  1
setenv G4ANALYSIS_BUILD  1
source /afs/cern.ch/sw/lhcxx/share/LHCXX/5.0.5/scripts/setupAnaphe.csh

setenv LD_LIBRARY_PATH /afs/cern.ch/sw/lhcxx/specific/redhat73/gcc-2.95.2/5.0.5/lib:$LD_LIBRARY_PATH
setenv LD_LIBRARY_PATH $OGLHOME/lib
setenv LD_LIBRARY_PATH /usr/local/gcc-alt-2.95.2/lib:$LD_LIBRARY_PATH
# ---- add to the LD_LIBRARY_PATH 

setenv PATH ${PATH}:/afs/cern.ch/sw/lhcxx/share/LHCXX/5.0.5/scripts/



2. How to run the example
-------------------------

- Run the "PurgMag" executable.
- File PurgMag.TABLE needs to be available in the current directory in order to run correctly.
- For visualisation use vis.mac. 
  Default visualization is with OpenGL
- Interactive or batch modes possible.
  Default: Interactive mode.

To run a certain number of events in interactive mode, 
type the following at the "idle>" prompt:

idle> run/beamOn  NumberOfEvents
idle> exit

- Simulation histogram output is stored in purgmag.hbk

1)Ntuple with position, energy and momentum for electrons
2)Ntuple with position, energy and momentum for photons 
  (not needed in this example, will be used in further development)
3)Ntuple with position, energy and momentum for positrons
  (not needed in this example, will be used in further development)

A default vizualisation macro (vis.mac) is pre-loaded before interactive runs.
Executing it
    osmachine.3% $G4WORKDIR/bin/Linux-g++/PurgMag 
runs vis.mac before giving you an interactive prompt.

	
3. Detector description
-----------------------

Simply a measurement volume. All particles entering the volume are scored.


4. Physics processes
--------------------

This example uses the standard Electromagnetic processes.


5. Particle Generator
----------------------

The PurgMagPrimaryGeneratorAction sets the initial state of tracks to

-electrons 50MeV
-Start position (0, 0, 15cm)
-Momentum direction (0, 0, -1)

 
6. Geometry and materials
--------------------------

The world consists of Vacuum to minimize interactions of the electrons
with the medium. The purging magnet is implemented as a 3D field grid 
of field values and geometerically as a pole gap made of iron. The 
measurement volume also contains vacuum. 

The field is interpolated using a simple linear interpolation in two 
dimensions (z and rho).

7. Comparison
--------------

The design of the magnetic field was made with the OPERA 3D package 
which is an electromagnetic finite element and finite difference 
analysis software. The deviation in the y-direction (ey in Ntuple 1)
has also been calculated in the OPERA 3D module TOSCA for comparison. 

TOSCA:  deviation y-direction: 35.112 cm
GEANT4: deviation y-direction: 35.170 cm (updated after PurgMag.pdf)

****************************************************************
*                                                              *
* More information about the setup and geometry in PurgMag.pdf *
*                                                              *
****************************************************************
